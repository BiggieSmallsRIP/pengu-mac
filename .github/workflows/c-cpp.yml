name: Build macOS Client

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Clone CEF Dependencies
      run: git clone https://github.com/nomi-san/cef-include -b 91.1.22-mac include

    - name: Manually Compile (The Nuclear Option)
      run: |
        # 1. Create a place to store object files
        mkdir build_objects

        # 2. Compile all C++ files (.cc) found in src/
        #    We ignore the Makefile and do it ourselves.
        echo "Compiling C++ sources..."
        find src -name "*.cc" -exec clang++ -std=c++17 -fPIC -arch x86_64 -I./ -I./src/ -fvisibility=hidden -c {} -o build_objects/{}.o \;

        # 3. Compile the Objective-C++ file (.mm)
        #    This handles the Mac-specific helper code.
        echo "Compiling Objective-C++ sources..."
        find src -name "*.mm" -exec clang++ -std=c++17 -fPIC -arch x86_64 -I./ -I./src/ -fvisibility=hidden -x objective-c++ -c {} -o build_objects/{}.o \;

        # 4. Link everything into the final dynamic library
        #    -undefined dynamic_lookup: This tells the linker to TRUST that the missing League symbols will exist at runtime.
        #    -framework Cocoa: Required for the Mac windowing code.
        echo "Linking..."
        clang++ -shared -dynamiclib -arch x86_64 -undefined dynamic_lookup -framework Cocoa -o core.dylib build_objects/src/*.o build_objects/src/**/*.o

    - name: Archive Production Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pengu-mac-client
        path: core.dylib
